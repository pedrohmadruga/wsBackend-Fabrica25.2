<!-- Herda o layout e estrutura do base.html-->
{% extends "base.html" %}

<!-- Título -->
{% block title %}Buscar Livros - Bookly{% endblock %}

<!-- Conteúdo -->
{% block content %}
<div class="card-body">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <a href="{% url 'home' %}" class="btn btn-secondary btn-sm">
      &larr; Voltar à página inical
    </a>

    <h3 class="mb-0 text-center flex-grow-1">Buscar livros</h3>

    <div class="d-flex justify-content-between align-items-center mb-4">
      {% if user.is_authenticated %}
      <a href="{% url 'profile' %}" class="btn btn-secondary btn-sm">
        Meu Perfil
      </a>
      {% else %}
      <a href="{% url 'login' %}" class="btn btn-secondary btn-sm">
        Fazer login
      </a>
      {% endif %}
    </div>
    </div>

    <!-- Formulário de pesquisa -->
    <form
      method="get"
      action="{% url 'search' %}"
      class="form-inline justify-content-center mb-4"
    >
      <input
        type="text"
        name="q"
        value="{{ query }}"
        class="form-control mr-2"
        placeholder="Digite o nome do livro"
        required
      />
      <button type="submit" class="btn btn-primary">Buscar</button>
    </form>

    <!-- Exibe apenas se tiver algum resultado -->
    {% if results %}
    <div class="row">
      {% for book in results %}
      <div class="col-md-4 mb-3">
        <div class="card h-100">
          {% if book.thumbnail %}
          <img
            src="{{ book.thumbnail }}"
            class="card-img-top"
            alt="{{ book.title }}"
          />
          {% endif %}
          <div class="card-body">
            <h5 class="card-title">{{ book.title }}</h5>
            <p class="card-text">
              <strong>Autores:</strong> {{ book.authors }}
            </p>
            <p class="card-text">
              <strong>Editora:</strong> {{ book.publisher }}
            </p>
            <p class="card-text">
              <strong>Publicado:</strong> {{ book.published_date }}
            </p>
            <!-- Só mostra botão de adicionar à lista se o usuário está logado -->
            {% if user.is_authenticated %}
            <form method="post" action="{% url 'add_book' %}">
              {% csrf_token %}
              <input
                type="hidden"
                name="google_book_id"
                value="{{ book.google_book_id }}"
              />
              <input type="hidden" name="title" value="{{ book.title }}" />
              <input type="hidden" name="authors" value="{{ book.authors }}" />
              <input
                type="hidden"
                name="publisher"
                value="{{ book.publisher }}"
              />
              <input
                type="hidden"
                name="published_date"
                value="{{ book.published_date }}"
              />
              <input
                type="hidden"
                name="thumbnail"
                value="{{ book.thumbnail }}"
              />
              <button type="submit" class="btn btn-success btn-block mt-2">
                Adicionar à lista
              </button>
            </form>
            {% else %}
            <!-- Link de login -->
            <a href="{% url 'login' %}" class="btn btn-secondary btn-block mt-2"
              >Login para adicionar</a
            >
            {% endif %}
            <a
              href="{% url 'book_detail' google_book_id=book.google_book_id %}"
              class="btn btn-primary btn-block mt-2"
            >
              Ver detalhes
            </a>
          </div>
        </div>
      </div>
      {% endfor %}
    </div>
    <!-- Se pesquisou e não encontrou nada, exibe uma mensagem -->
    {% elif query %}
    <p class="text-center mt-4">
      Nenhum resultado encontrado para "{{ query }}"
    </p>
    {% endif %}

    <!-- Lógica de paginação-->
    {% if total_pages > 1 %} <!-- Só exibe a barra de paginação se houver mais de uma página -->
    <nav aria-label="Page navigation"> <!-- HTML do bootstrap para estilizar a paginação-->
      <ul class="pagination justify-content-center mt-4">
        <!-- Botão "anterior" -->
        {% if page > 1 %}
        <li class="page-item">
          <!-- Se não for a primeira página, decrementa 1 da página atual para gerar o link da página anterior -->
          <a
            class="page-link"
            href="?q={{ query }}&page={{ page|add:-1 }}" 
            aria-label="Previous"
          >
            &laquo;
          </a>
        </li>
        {% endif %}

        <!-- Lista de número de páginas, gerada na view -->
        {% for p in pages %} {% if p == page %} <!-- Se for a página atual, coloca class active-->
        <li class="page-item active">
          <span class="page-link">{{ p }}</span>
        </li>
        {% else %}
        <li class="page-item">
          <a class="page-link" href="?q={{ query }}&page={{ p }}">{{ p }}</a>
        </li>
        {% endif %} {% endfor %}

        <!-- Se não for a última página, acrescenta 1 à página atual para o link da próxima página -->
        {% if page < total_pages %}
        <li class="page-item">
          <a
            class="page-link"
            href="?q={{ query }}&page={{ page|add:1 }}"
            aria-label="Next"
          >
            &raquo;
          </a>
        </li>
        {% endif %}
      </ul>
    </nav>
    {% endif %}
  </div>
  {% endblock %}

  <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/popper.js@1.12.9/dist/umd/popper.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/js/bootstrap.min.js"></script>
</div>
