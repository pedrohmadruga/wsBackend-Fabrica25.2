{% extends "base.html" %}

<!-- Título -->
{% block title %}Meu Perfil - Bookly{% endblock %}

<!-- Conteúdo -->
{% block content %}
{% if messages %}
<div class="container mt-3">
    {% for message in messages %}
    <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
        {{ message }}
        <button type="button" class="close" data-dismiss="alert" aria-label="Fechar">
            <span aria-hidden="true">&times;</span>
        </button>
    </div>
    {% endfor %}
</div>
{% endif %}

<div class="card-body">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <a href="{% url 'search' %}" class="btn btn-secondary btn-sm">
      &larr; Voltar à busca
    </a>

    <h3 class="mb-0 text-center flex-grow-1">Minha Lista de Livros</h3>

    <form method="get" class="ml-2">
      <select name="status" class="form-control form-control-sm" onchange="this.form.submit()">
        <option value="">Todos os status</option>
        <option value="plan" {% if status_selected == "plan" %}selected{% endif %}>Planejo ler</option>
        <option value="reading" {% if status_selected == "reading" %}selected{% endif %}>Lendo</option>
        <option value="completed" {% if status_selected == "completed" %}selected{% endif %}>Completo</option>
        <option value="dropped" {% if status_selected == "plan" %}selected{% endif %}>Abandonado</option>
      </select>
    </form>
  </div>

  {% if books %}
  <div class="row">
    {% for userbook in books %}
    <div class="col-md-4 mb-3">
      <div class="card h-100">
        {% if userbook.book.thumbnail %}
        <img
          src="{{ userbook.book.thumbnail }}"
          class="card-img-top"
          alt="{{ userbook.book.title }}"
        />
        {% endif %}
        <div class="card-body">
          <h5 class="card-title">{{ userbook.book.title }}</h5>
          <p class="card-text">
            <strong>Autores:</strong> {{ userbook.book.authors }}
          </p>
          <p class="card-text">
            <strong>Editora:</strong> {{ userbook.book.publisher }}
          </p>
          <p class="card-text">
            <strong>Publicado:</strong> {{ userbook.book.published_date }}
          </p>
          <p class="card-text">
            <strong>Status:</strong> {{ userbook.get_status_display }}
          </p>
          <!-- Form editar status -->
          <form method="post" action="{% url 'update_status' userbook.id %}" class="mb-2">
            {% csrf_token %}
            <div class="input-group">
              <select name="status" class="form-control form-control-sm">
                {% for key, value in userbook.STATUS_CHOICES %}
                  <option value="{{ key }}" {% if userbook.status == key %}selected{% endif %}>{{ value }}</option>
                {% endfor %}
              </select>
              <div class="input-group-append">
                <button type="submit" class="btn btn-primary btn-sm">
                  Editar
                </button>
              </div>
            </div>
          </form>

          <!-- Form remover -->
          <form method="post" action="{% url 'remove_book' userbook.id %}">
            {% csrf_token %}
            <button type="submit" class="btn btn-danger btn-sm btn-block">
            Remover
            </button>
          </form>

          {% if userbook.book.google_book_id %}
          <a
            href="{% url 'book_detail' google_book_id=userbook.book.google_book_id %}"
            class="btn btn-primary btn-block mt-2"
          >Ver Detalhes</a>
          {% endif %}
        </div>
      </div>
    </div>
    {% endfor %}
  </div>

  {% if is_paginated %}
  <nav aria-label="Page navigation">
    <ul class="pagination justify-content-center mt-4">
      {% if page_obj.has_previous %}
      <li class="page-item">
        <a class="page-link" href="?page={{ page_obj.previous_page_number }}"
          >&laquo;</a
        >
      </li>
      {% endif %} {% for num in page_obj.paginator.page_range %}
      <li class="page-item {% if page_obj.number == num %}active{% endif %}">
        <a class="page-link" href="?page={{ num }}">{{ num }}</a>
      </li>
      {% endfor %} {% if page_obj.has_next %}
      <li class="page-item">
        <a class="page-link" href="?page={{ page_obj.next_page_number }}"
          >&raquo;</a
        >
      </li>
      {% endif %}
    </ul>
  </nav>
  {% endif %} {% else %}
  <p class="text-center">Você ainda não adicionou livros à sua lista.</p>
  {% endif %}
</div>
{% endblock %}
